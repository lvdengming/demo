<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./style.css" />
    <title>抽签</title>
  </head>

  <body>
    <div id="app">
      <header class="">
        <div class="import-wrapper">
          <div class="import">
            <input
              type="file"
              id="import-excel"
              accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            />
            <span>选择文件</span>
          </div>
          <div class="file-name">暂无文件</div>
        </div>
        <a href="https://lvdengming.com/demo/#/lottery/lottery_template.xlsx"
          >下载模板</a
        >
      </header>

      <section class="lottery-wrapper">
        <div class="teams"></div>

        <div class="lottery">
          <div class="buttons">
            <div class="start">开始</div>
            <div class="stop">停止</div>
          </div>
          <h1>-</h1>
          <div class="order"></div>
        </div>

        <div class="selected-teams"></div>
      </section>
    </div>
    <!-- use xlsx.full.min.js from version 0.19.2 -->
    <script
      lang="javascript"
      src="https://cdn.sheetjs.com/xlsx-0.19.2/package/dist/xlsx.full.min.js"
    ></script>
    <script>
      let fileName = '';
      const teams = [];
      const selectedTeams = [];
      const memebers = [];
      let index = 0;
      let timer = null;
      let h1El;

      function handlePageLoad() {
        const importInput = document.getElementById('import-excel');
        importInput.addEventListener('change', handleInputChange, false);

        const startButton = document.querySelector('.buttons .start');
        startButton.addEventListener('click', startLottery);
        const stopButton = document.querySelector('.buttons .stop');
        stopButton.addEventListener('click', stopLottery);

        h1El = document.querySelector('.lottery h1');
      }

      function handleInputChange(e) {
        const excel = e.target.files[0];
        fileName = excel.name;

        const reader = new FileReader();
        reader.onload = function (e) {
          const data = e.target.result;
          /* reader.readAsArrayBuffer(file) -> data will be an ArrayBuffer */
          const workbook = XLSX.read(e.target.result);
          const [sheetName] = workbook.SheetNames;
          extractSheet(workbook.Sheets[sheetName]);
        };
        reader.readAsArrayBuffer(excel);
      }

      function extractSheet(sheet) {
        // 每次导入数据时，状态重置
        teams.length = 0;
        selectedTeams.length = 0;
        memebers.length = 0;

        const [colA, colB, colC] = ['A', 'B', 'C'];
        let rowCount = 2;
        while (sheet.hasOwnProperty(colA + rowCount)) {
          const team = [
            sheet[colA + rowCount].v,
            sheet[colB + rowCount].v,
            sheet[colC + rowCount].v,
          ];
          teams.push(team);
          memebers.push(...team);

          rowCount++;
        }

        render();
      }

      function render() {
        const teamsEl = document.querySelector('.teams');
        teamsEl.innerHTML = '';
        for (const team of teams) {
          const teamEl = document.createElement('div');
          teamEl.classList.add('team-item');
          teamEl.append(...createTeamChilds(team));

          teamsEl.append(teamEl);
        }

        const selectedTeamsEl = document.querySelector('.selected-teams');
        selectedTeamsEl.innerHTML = '';
        for (const team of selectedTeams) {
          const teamEl = document.createElement('div');
          teamEl.classList.add('team-item');
          teamEl.append(...createTeamChilds(team));

          selectedTeamsEl.append(teamEl);
        }
      }

      function createTeamChilds(team) {
        const els = [];
        for (const memeber of team) {
          const spanEl = document.createElement('span');
          spanEl.innerText = memeber;
          els.push(spanEl);
        }
        return els;
      }

      function startLottery() {
        if (!teams.length) {
          const message = selectedTeams.length ? '抽签已结束' : '请导入数据';
          window.alert(message);
          return;
        }

        if (timer) {
          window.clearInterval(timer);
        }

        timer = window.setInterval(() => {
          index = createRandomIndex();
          h1El.innerText = memebers[index];
        }, 50);
      }

      function stopLottery() {
        if (!teams.length) {
          const message = selectedTeams.length ? '抽签已结束' : '请导入数据';
          window.alert(message);
          return;
        }

        window.clearInterval(timer);
        const memeber = memebers[index];
        const teamIndex = teams.findIndex((item) => item.includes(memeber));

        const team = teams[teamIndex];
        teams.splice(teamIndex, 1);
        selectedTeams.push(team);

        team.map((item) => {
          const idx = memebers.findIndex((memeber) => memeber === item);
          memebers.splice(idx, 1);
        });

        const orderEl = document.querySelector('.order');
        if (!orderEl.innerText) {
          orderEl.innerText = `抽签顺序：${memeber}`;
        } else {
          orderEl.innerText += ` -> ${memeber}`;
        }

        render();
      }

      function createRandomIndex() {
        let start = 0;
        let end = memebers.length - 1;
        return Math.round(Math.random() * (end - start) + start);
      }

      window.onload = handlePageLoad;
    </script>
  </body>
</html>
